# Yoradio –¥–ª—è ESP32-4848S040 (ST7701 RGB 480x480)

**–í–µ—Ç–∫–∞:** `4848S040`  
**–í–µ—Ä—Å–∏—è:** v0.9.434(m)  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í —Ä–∞–±–æ—Ç–µ!
![photo_2025-08-15_00-06-22](https://github.com/user-attachments/assets/bb047124-7e1a-4d0a-8f70-b78dccf4fd36)

## üìù –õ–æ–≥ –∏–∑–º–µ–Ω–µ–Ω–∏–π

**02.09.2025** - –î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è SD –∫–∞—Ä—Ç—ã:
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è SPI –¥–ª—è SD –∫–∞—Ä—Ç—ã (FSPI/SPI2_HOST)
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω deadlock –≤ mutex –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ `_checkNoMedia()`
- ‚úÖ SD –∫–∞—Ä—Ç–∞ —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –∏ –∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ—Ç—Å—è
- ‚úÖ –ü–ª–µ–π–ª–∏—Å—Ç —Å–æ–∑–¥–∞–µ—Ç—Å—è –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —á–∏—Ç–∞–µ—Ç—Å—è
- ‚úÖ –°–ø–∏—Å–æ–∫ –∫–æ–º–ø–æ–∑–∏—Ü–∏–π –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∏ –ª–∏—Å—Ç–∞–µ—Ç—Å—è
- ‚ùå **–ü–†–û–ë–õ–ï–ú–ê:** –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç - —Å–∏—Å—Ç–µ–º–∞ –∑–∞–≤–∏—Å–∞–µ—Ç –≤ `config.loadStation()`

**–°–º. [ISSUE: SD Card Playback Problem](#-sd-card-playback-issue)**

> **‚ö†Ô∏è –í–ê–ñ–ù–û:** –î–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Ä–∞–¥–∏–æ –Ω–∞ –±–æ–ª—å—à–∏—Ö –±–∏—Ç—Ä–µ–π—Ç–∞—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–º–µ–Ω–∏—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ IDF –Ω–∞ –ø–µ—Ä–µ–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–µ—Ä—Å–∏–∏. –°–º. —Ä–∞–∑–¥–µ–ª [–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫](#-—É—Å—Ç–∞–Ω–æ–≤–∫–∞-–±–∏–±–ª–∏–æ—Ç–µ–∫).


## üéØ –û–ø–∏—Å–∞–Ω–∏–µ

–ü–æ—Ä—Ç –ø—Ä–æ–µ–∫—Ç–∞ [Yoradio] –¥–ª—è –º–æ–¥—É–ª—è **ESP32-4848S040** —Å –¥–∏—Å–ø–ª–µ–µ–º **ST7701**:
- **–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ:** 480x480 –ø–∏–∫—Å–µ–ª–µ–π (–∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–π —ç–∫—Ä–∞–Ω)
- **–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å:** RGB Panel (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π, 16 –ª–∏–Ω–∏–π –¥–∞–Ω–Ω—ã—Ö)
- **–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä:** ESP32-S3-WROOM-1-N16R8 (240MHz, dual-core)
- **–ü–∞–º—è—Ç—å:** 520KB RAM + 16MB PSRAM + 8MB Flash
- **–¢–∞—á—Å–∫—Ä–∏–Ω:** GT911 (–µ–º–∫–æ—Å—Ç–Ω—ã–π, I2C) - **–ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω**
- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ I2S - 3.3.2

## üöÄ –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

- ‚úÖ **ST7701 RGB Panel 480x480** - –≤—ã—Å–æ–∫–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
- ‚úÖ **GT911 —Ç–∞—á—Å–∫—Ä–∏–Ω** - —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –º—É–ª—å—Ç–∏—Ç–∞—á–∞ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π –¥–ª—è –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
- ‚úÖ **–°–ø–µ–∫—Ç—Ä–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä** - –∑–∞–º–µ–Ω–∞ VU-–º–µ—Ç—Ä–∞
- ‚úÖ **–†—É—Å—Å–∫–∞—è –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è** - –ø–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞
- ‚úÖ **WiFi –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Ä–∞–¥–∏–æ** - –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
- ‚úÖ **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è ESP32-S3** - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ **–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–µ—Å—Ç–∞–º–∏** - —Ç–æ—á–Ω—ã–µ —Å–≤–∞–π–ø—ã –∏ –º—É–ª—å—Ç–∏—Ç–∞—á

## üîß –°–±–æ—Ä–∫–∞

–î–ª—è —Ä—É—Å—Å–∫–æ–π –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ –∑–∞–º–µ–Ω—è–µ–º —Ñ–∞–π–ª fonts/glcdfont.h –ø–æ –∞–¥—Ä–µ—Å—É: pio\libdeps\yoradio-esp32s3\GFX Library for Arduino\src\font


## üì± –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

- **`src/myoptions.h`** - –æ—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥—É–ª—è
- **`src/src/displays/displayST7701.cpp`** - –¥—Ä–∞–π–≤–µ—Ä –¥–∏—Å–ø–ª–µ—è
- **`src/src/core/touchscreen.cpp`** - –¥—Ä–∞–π–≤–µ—Ä —Ç–∞—á—Å–∫—Ä–∏–Ω–∞ GT911 (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω)

## üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫

–î–ª—è —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã –∑–∞–∏–∫–∞–Ω–∏—è –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Ä–∞–¥–∏–æ –Ω–∞ –±–æ–ª—å—à–∏—Ö –±–∏—Ç—Ä–µ–π—Ç–∞—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–º–µ–Ω–∏—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ IDF –Ω–∞ –ø–µ—Ä–µ–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–µ—Ä—Å–∏–∏:

### üìÅ –ó–∞–º–µ–Ω–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫

1. **–ù–∞–π–¥–∏—Ç–µ –ø–∞–ø–∫—É PlatformIO:**
   ```
   <user>/.platformio/packages/framework-arduinoespressif32-libs/esp32s3/lib/
   ```

2. **–ó–∞–º–µ–Ω–∏—Ç–µ —Ñ–∞–π–ª—ã:**
   - `libesp_netif.a` ‚Üí `libesp_netif.a` (–∏–∑ –∞—Ä—Ö–∏–≤–∞)
   - `liblwip.a` ‚Üí `liblwip.a` (–∏–∑ –∞—Ä—Ö–∏–≤–∞)

3. **–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –≤–µ—Ä—Å–∏–∏ IDF:**
   - ‚úÖ ESP-IDF 5.4
   - ‚úÖ ESP-IDF 5.5

### üì¶ –ê—Ä—Ö–∏–≤ —Å –±–∏–±–ª–∏–æ—Ç–µ–∫–∞–º–∏

–ü–µ—Ä–µ–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –ø–∞–ø–∫–µ `library!/esp32s3_5.4/`:
- `libesp_netif.a` (496KB)
- `liblwip.a` (3.8MB)

> **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ü–æ—Å–ª–µ –∑–∞–º–µ–Ω—ã –±–∏–±–ª–∏–æ—Ç–µ–∫ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ PlatformIO –∏ –ø–µ—Ä–µ–∫–æ–º–ø–∏–ª–∏—Ä—É–π—Ç–µ –ø—Ä–æ–µ–∫—Ç.

## üéÆ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

- **–û–¥–∏–Ω–æ—á–Ω–æ–µ –∫–∞—Å–∞–Ω–∏–µ** - —Å—Ç–∞—Ä—Ç/—Å—Ç–æ–ø
- **–°–≤–∞–π–ø –≤–ª–µ–≤–æ/–≤–ø—Ä–∞–≤–æ** - –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≥—Ä–æ–º–∫–æ—Å—Ç–∏ (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ)
- **–°–≤–∞–π–ø –≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑** - –≤—ã–±–æ—Ä —Å—Ç–∞–Ω—Ü–∏–∏ (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ)
- **–î–≤–æ–π–Ω–æ–µ –∫–∞—Å–∞–Ω–∏–µ** - —Å–º–µ–Ω–∞ —Ä–µ–∂–∏–º–∞ (RADIO ‚Üî SD)
- **–ú—É–ª—å—Ç–∏—Ç–∞—á** - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

## üìä –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ |
|-----------|----------------|
| **–î–∏—Å–ø–ª–µ–π** | ST7701 RGB Panel 480x480 |
| **–¢–∞—á—Å–∫—Ä–∏–Ω** | GT911 (SDA:19, SCL:45) - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è 480x480 |
| **–ê—É–¥–∏–æ** | I2S (BCLK:1, LRCLK:2, DOUT:40) |
| **–ü–æ–¥—Å–≤–µ—Ç–∫–∞** | PWM —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–ø–∏–Ω 38) |
| **–§–æ—Ä–º–∞—Ç** | RGB565 (16-bit color) |

## üîç –û—Ç–ª–∞–¥–∫–∞

```cpp
// –í–∫–ª—é—á–∏—Ç—å –æ—Ç–ª–∞–¥–∫—É –¥–∏—Å–ø–ª–µ—è
#define DEBUG_DISPLAY

// –í–∫–ª—é—á–∏—Ç—å –æ—Ç–ª–∞–¥–∫—É —Ç–∞—á—Å–∫—Ä–∏–Ω–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
#define DEBUG_TOUCH
```

## üêõ –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

- ‚ùå **SD –∫–∞—Ä—Ç–∞: –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç** (—Å–º. —Ä–∞–∑–¥–µ–ª –Ω–∏–∂–µ)
- ‚úÖ **–¢–∞—á—Å–∫—Ä–∏–Ω GT911 –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω**

## üö® SD Card Playback Issue

### Problem Description
SD card integration works perfectly for indexing and playlist reading during boot/initialization, but **hangs during audio playback** when user presses Play button.

### Specific Failure Point
The system hangs in `config.loadStation()` function when attempting to open SD card files:
```cpp
File playlist = SDPLFS()->open(REAL_PLAYL, "r");  // ‚Üê HANGS HERE
File index = SDPLFS()->open(REAL_INDEX, "r");     // ‚Üê NEVER REACHED
```

### Working Scenarios
- ‚úÖ SD card initialization and mounting
- ‚úÖ SD card indexing (creates playlistsd.csv and indexsd.dat)
- ‚úÖ Playlist reading during boot sequence
- ‚úÖ All cardPresent() checks pass
- ‚úÖ File existence checks pass

### Failing Scenario
- ‚ùå Audio playback when user presses Play button
- ‚ùå System hangs on SDPLFS()->open() calls in loadStation()

### Technical Details
- **Board:** ESP32-S3 N16R8
- **Display:** ST7701 RGB 480x480 (uses VSPI)
- **SD Card:** FSPI (SPI2_HOST) with custom pins: CS=42, SCK=48, MISO=41, MOSI=47
- **Audio:** I2S (no SPI conflict)
- **FreeRTOS:** mutex system implemented for thread safety

### Attempted Solutions
1. Changed SD card SPI from FSPI to HSPI - no effect
2. Added mutex timeouts and forced release - no effect
3. Simplified cardPresent() check (removed readRAW) - no effect
4. Suspended display task during SD access - no effect
5. Removed all SD state checks - still hangs on file open

### Root Cause Hypothesis
The issue appears to be in the SD card file system layer (SDPLFS()->open()) rather than SPI communication or mutex management. The same SD card operations work fine during boot but fail during runtime playback context.

### Developer Request
If you can identify why SDPLFS()->open() works during boot but hangs during playback, please help resolve this issue. The SD card hardware and basic file operations are confirmed working.

## üìù –õ–∏—Ü–µ–Ω–∑–∏—è

MIT License - —Å–º. —Ñ–∞–π–ª [LICENSE](LICENSE)

---

**–í–µ—Ä—Å–∏—è –¥–ª—è –≤–µ—Ç–∫–∏ 4848S040** - –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ–¥ –º–æ–¥—É–ª—å ESP32-4848S040 —Å –¥–∏—Å–ø–ª–µ–µ–º ST7701 –∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º —Ç–∞—á—Å–∫—Ä–∏–Ω–æ–º GT911

